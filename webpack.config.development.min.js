const glob = require("glob");
const path = require( 'path' );

const webpack = require('webpack')
const MiniCssExtractPlugin = require('mini-css-extract-plugin')
const WebpackAssetsManifest = require('webpack-assets-manifest')
const CaseSensitivePathsPlugin = require('case-sensitive-paths-webpack-plugin')
const OptimizeCSSAssetsPlugin = require('optimize-css-assets-webpack-plugin')

module.exports = {
  entry:
    { application:
      path.join(__dirname, 'app/javascript/packs/application.js') },

  output:
   { filename: '[name]-[hash].js',
     path: path.join(__dirname, 'public/packs'),
     publicPath: '/packs/' },

  resolve: {
    extensions:
      [ '.tsx',
        '.ts',
        '.jsx',
        '.mjs',
        '.js',
        '.sass',
        '.scss',
        '.css',
        '.png',
        '.svg',
        '.gif',
        '.jpeg',
        '.jpg' ],
    modules:
      [ path.join(__dirname, 'app/javascript'),
        'node_modules' ],},
  cache: true,
  devtool: 'cheap-module-source-map',
  devServer:
   { clientLogLevel: 'none',
     compress: true,
     quiet: false,
     disableHostCheck: true,
     host: 'localhost',
     port: 3035,
     https: false,
     hot: false,
     contentBase: path.join(__dirname, 'public/packs'),
     inline: true,
     useLocalIp: false,
     public: 'localhost:3035',
     publicPath: '/packs/',
     historyApiFallback: { disableDotRule: true },
     headers: { 'Access-Control-Allow-Origin': '*' },
     overlay: true,
     stats:
      { entrypoints: false,
        errorDetails: false,
        modules: false,
        moduleTrace: false },
     watchOptions: { ignored: '/node_modules/' } },
  module:
   { strictExportPresence: true,
     rules:
      [ { test: /\.(ts|tsx)?(\.erb)?$/,
          use: [ { loader: 'ts-loader', options: {} } ] },
        { test:
           /(.jpg|.jpeg|.png|.gif|.tiff|.ico|.svg|.eot|.otf|.ttf|.woff|.woff2)$/i,
          use:
           [ { loader: 'file-loader',
               options:
                { name: '[path][name]-[hash].[ext]', context: 'app/javascript' } } ] },
        { test: /\.(css)$/i,
          use:
           [ { loader: 'style-loader',
               options: { hmr: false, sourceMap: true } },
             { loader: 'css-loader',
               options:
                { sourceMap: true,
                  importLoaders: 2,
                  localIdentName: '[name]__[local]___[hash:base64:5]',
                  modules: false } }, ],
          sideEffects: true },
        { test: /\.(scss|sass)$/i,
          use:
           [ { loader: 'style-loader',
               options: { hmr: false, sourceMap: true } },
             { loader: 'css-loader',
               options:
                { sourceMap: true,
                  importLoaders: 2,
                  localIdentName: '[name]__[local]___[hash:base64:5]',
                  modules: false } },
             { loader: 'sass-loader', options: { sourceMap: true } } ],
          sideEffects: true },
        { test: /\.(js|mjs)$/,
          exclude: /@babel(?:\/|\\{1,2})runtime/,
          use:
           [ { loader: 'babel-loader',
               options:
                { babelrc: false,
                  presets: [ [ '@babel/preset-env', { modules: false } ] ],
                  cacheDirectory: 'tmp/cache/webpacker/babel-loader-node-modules',
                  cacheCompression: false,
                  compact: false,
                  sourceMaps: false } } ] },
        { test: /\.(js|jsx|mjs)?(\.erb)?$/,
          exclude: /node_modules/,
          use:
           [ { loader: 'babel-loader',
               options:
                { cacheDirectory: 'tmp/cache/webpacker/babel-loader-node-modules',
                  cacheCompression: false,
                  compact: false } } ] } ] },
  plugins:
    [ new webpack.EnvironmentPlugin(JSON.parse(JSON.stringify(process.env))),
      new CaseSensitivePathsPlugin(),
      new WebpackAssetsManifest({
        writeToDisk: true,
        publicPath: true
      }) ],

};
